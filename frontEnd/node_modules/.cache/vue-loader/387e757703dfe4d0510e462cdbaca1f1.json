{"remainingRequest":"/Users/movi/Desktop/current/frontEnd/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/movi/Desktop/current/frontEnd/src/views/event/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/movi/Desktop/current/frontEnd/src/views/event/index.vue","mtime":1682065451190},{"path":"/Users/movi/Desktop/current/frontEnd/node_modules/babel-loader/lib/index.js","mtime":1669512949620},{"path":"/Users/movi/Desktop/current/frontEnd/node_modules/cache-loader/dist/cjs.js","mtime":1651221196058},{"path":"/Users/movi/Desktop/current/frontEnd/node_modules/vue-loader/lib/index.js","mtime":1669512954316}],"contextDependencies":[],"result":["\nimport { reqEvent, deleteEvent, updateEvent, bindEvent, bindedUserIDList, updateJson } from '@/api/event.js'\nimport { reqUserList } from '@/api/user'\nimport { mapGetters } from 'vuex'\nimport { notification } from 'ant-design-vue';\nimport * as echarts from \"echarts\"\nexport default {\n  name: 'Event',\n  data() {\n    return {\n      data: null,\n      selectedRowKeys: [], // Check here to configure the default column\n      columns: [\n        {\n          title: 'id',\n          dataIndex: 'id',\n          key: 'id',\n          width: '80px'\n        },\n        // {\n        //   title: '简介',\n        //   key:'introduction',\n        //   dataIndex: 'introduction',\n        //   ellipsis:true\n        // },\n        {\n          title: '主题',\n          key:'name',\n          dataIndex: 'name',\n          ellipsis:true,\n          width: '80'\n        },\n        // {\n        //   title: '发生经过',\n        //   key:'process',\n        //   dataIndex: 'process',\n        //   ellipsis:true\n        // },\n        {\n          title: '类型',\n          key:'type',\n          dataIndex: 'type',\n          width: '90px'\n        },\n        // {\n        //   title: 'url',\n        //   key:'url',\n        //   dataIndex: 'url'\n        // },\n        {\n          title: '操作',\n          key: 'action',\n          scopedSlots: { customRender: 'action' },\n          width: '220'\n        },\n      ],\n      page_num:1,\n      page_size:10,\n      total:0,\n      type: null,\n      // 文件上传\n      uploadModalVisible: false,\n      confirmLoading: false,\n      file: null,\n      fileList: [],\n      // 上传json\n      updateJsonModalVisible:false,\n      json: null,\n      jsons: [],\n      // 展示json\n      viewJsonModalVisible: false,\n      myChart: null,\n      jsonData: null,\n      nodeForm: null,\n      nodeIndex: null,\n      nodeModalVisible: false,\n      // 分配\n      bindModalVisible: false,\n      userIDList: [],\n      userList:[],\n      toBindEventName: \"\",\n      // 更新\n      updateModalVisible: false,\n      form: {\n        name: \"\",\n        introduction: \"\",\n        url: \"\",\n        process: \"\",\n        type: \"\"\n      },\n    };\n  },\n  computed:{\n    ...mapGetters(['roleType']),\n  },\n  methods:{\n    initEchart() {\n      if(!this.myChart){\n        let dom = document.getElementById(\"echarts\");\n        this.myChart = echarts.init(dom);\n      }\n      var option;\n      option = {\n        tooltip: {\n          formatter: function(params) {\n            let data = params.data\n            let html = '<div style=\"width:280px;height:180px;background:#5370c6;border:1px solid rgba(7,166,255,0.7)\">'\n              +'<div style=\"width:100%;min-height:22px;line-height:22px;border-bottom:2px solid rgba(7,166,255,0.7);padding:0 20px\">'\n              +'<span style=\"color:#fff;font-size:14px;word-wrap:break-word;white-space:normal;\">'+params.name+'</span>'+'</div>'\n              +'<div style=\"padding:20px\">'\n            for(let key in data){\n              if([\"name\", \"x\", \"y\"].indexOf(key) === -1){\n                html+=`<p style=\"color:#fff;font-size:12px;\">\n                        ${key}: ${data[key]}</span>\n                       </p>`\n              }\n            }\n            html += '</div>'+'</div>';\n            return html;\n          }\n        },\n        animationDurationUpdate: 1500,\n        animationEasingUpdate: \"quinticInOut\",\n        series: [\n          {\n            type: \"graph\",\n            layout: \"none\",\n            symbolSize: 50,\n            roam: true,\n            label: {\n              formatter: '{b}',\n              show: true,\n            },\n            edgeSymbol: [\"circle\", \"arrow\"],\n            edgeSymbolSize: [4, 10],\n            edgeLabel: {\n              fontSize: 20,\n            },\n            data: this.json.dict_ls,\n            links: this.json.links,\n            lineStyle: {\n              opacity: 0.9,\n              width: 2,\n              curveness: 0,\n            },\n          },\n        ],\n      };\n      option && this.myChart.setOption(option);\n      const that = this\n      this.myChart.on('click', function (params) {\n        let data = params.data\n        // 如果除了name,x,y外无其他的key，则不弹窗\n        if(params.data && Object.keys(data).length>3){\n          that.nodeModalVisible = true\n          that.nodeForm = data\n          that.nodeIndex = params.dataIndex\n        }\n      });\n    },\n    async handlePageChange(page_num, page_size) {\n      let res = await reqEvent({ page_num: page_num, page_size: page_size })\n      this.data = res.result.events\n      this.total = res.result.count\n    },\n    async handleEventChange(page_num,page_size){\n      let res = await reqEvent({page_num:page_num,page_size:page_size})\n      this.data = res.result.events\n      this.total = res.result.count\n    },\n    showUploadModal(jsonData){\n      this.uploadModalVisible = true\n    },\n    onSelectChange(selectedRowKeys) {\n      this.selectedRowKeys = selectedRowKeys;\n    },\n    closeModal(){\n      this.form = {\n        name: \"\",\n        introduction: \"\",\n        url: \"\",\n        process: \"\",\n        type: \"\"\n      }\n      this.toBindEventName = \"\"\n      this.userIDList = []\n      this.bindModalVisible = false\n      this.updateModalVisible = false\n      this.updateJsonModalVisible = false\n      this.json = null\n      this.jsons = []\n      this.selectedRowKeys = []\n      this.fileList = []\n      this.getTableData()\n    },\n    async submitUpdateJson(){\n      let res = await updateJson({jsons: this.jsons})\n      if(res.code === 200){\n        notification[\"success\"]({\n          message: '更新成功',\n        });\n        this.closeModal()\n      }\n    },\n    detail(name){\n      this.$router.push({path: \"/event/eventDetail\", query: {name: name}})\n    },\n    handleRemove(file){\n      const index = this.fileList.indexOf(file);\n      const newFileList = this.fileList.slice();\n      newFileList.splice(index, 1);\n      this.fileList = newFileList;\n    },\n    convertJsonToEchartData(file){\n      this.fileList = [...this.fileList, file];\n      const that = this\n      for(let i = 0; i < this.fileList.length; i++){\n        let f = this.fileList[i]\n        let reader = new FileReader()\n        reader.readAsText(f, \"UTF-8\")\n        reader.onload = _ =>{\n          let json = JSON.parse(reader.result)\n          let jsonFileName = f.name;\n\n          // 每次增加的步长\n          let stepX = 40;\n          let stepY = 40;\n          let positionDict = {};\n          let dict_ls = [];\n          let zeroPointPostionx = 100;\n          let zeroPointPostiony = 100;\n\n          let x = 0;\n          let y = 0;\n\n          dict_ls.push({ name: jsonFileName, x: x, y: y });\n\n          // 关系列表\n          let links = [];\n\n          // 子分支列表存放\n          let next_ls = [];\n\n          // 存放第一层分支的数量\n          let fatherNum = 0;\n          for (let name in json) {\n            let dict = {};\n            dict[\"name\"] = name;\n\n            // 是否是第一层分支\n            if (next_ls.indexOf(name) === -1) {\n              fatherNum++;\n              if(fatherNum%2 == 0){\n                x = zeroPointPostionx - stepX;\n                y = zeroPointPostiony - stepY * fatherNum;\n                dict[\"x\"] = x;\n                dict[\"y\"] = y;\n              }else{\n                x = zeroPointPostionx - stepX;\n                y = zeroPointPostiony - stepY * fatherNum;\n                dict[\"x\"] = x;\n                dict[\"y\"] = y;\n              }\n\n              positionDict[name] = { x:-2*x, y: y };\n              links.push({\n                target: name,\n                source: jsonFileName,\n              });\n            } else {\n              dict[\"x\"] = positionDict[name].x;\n              dict[\"y\"] = positionDict[name].y;\n            }\n\n            let sonNum = 0;\n            for (let val in json[name]) {\n              let key = json[name][val];\n              let links_item = {};\n              if (key[0] === \"next\") {\n                sonNum = sonNum + 1;\n                next_ls.push(val);\n                let x = positionDict[name].x + stepX;\n                let y = positionDict[name].y + stepY * sonNum;\n                positionDict[val] = { x: x, y: y };\n                links_item[\"target\"] = val;\n                links_item[\"source\"] = name;\n                links.push(links_item);\n              } else {\n                dict[key] = val;\n              }\n            }\n            dict_ls.push(dict);\n          }\n          that.jsons.push({\n            name: jsonFileName,\n            json: JSON.stringify({\n              dict_ls: dict_ls,\n              links: links\n            })\n          })\n        }\n      }\n      return false;\n    },\n    handleOk(){\n      this.confirmLoading = false\n      this.uploadModalVisible = false\n      this.updateModalVisible = false\n    },\n    async getTableData(){\n      let res = await reqEvent({page_num:1,page_size:10,type: this.type})\n      this.data = res.result.events\n      this.total = res.result.count\n      this.page_num = res.result.page_num\n      this.page_size = res.result.page_size\n    },\n    async submitForm(){\n      this.confirmLoading = true\n      let res = await updateEvent(this.form)\n      if(res.code === 200){\n        this.confirmLoading = false\n        this.updateModalVisible = false\n        this.getTableData()\n        notification[\"success\"]({\n          message: '更新成功',\n        });\n      }\n    },\n    handleChange(info){\n      if (info.file.status !== 'uploading') {\n        console.log(info.file, info.fileList);\n      }\n      if (info.file.status === 'done') {\n        notification[\"success\"]({\n          message: '上传成功',\n        });\n      } else if (info.file.status === 'error') {\n        notification[\"error\"]({\n          message: '上传失败',\n        });\n      }\n    },\n    async batchBind(){\n      if(!this.selectedRowKeys.length){\n        notification[\"error\"]({\n          message: '请选择要分配的事件',\n        });\n        return\n      }\n      this.bindModalVisible = true\n      this.toBindEventName = \"batchBind\"\n      await this.getBindedUserIDList()\n    },\n    async bindUsers(name){\n      this.bindModalVisible = true\n      this.toBindEventName = name\n      await this.getBindedUserIDList()\n    },\n    async getBindedUserIDList(){\n      let res = await bindedUserIDList({event_name: this.toBindEventName})\n      if(res.code === 200){\n        this.userIDList = res.result.bindedUserIDList\n      }\n    },\n    async submitBindForm(){\n      if(!this.toBindEventName || !this.userIDList.length){\n        notification[\"error\"]({\n          message: '关键数据缺失，请重试！',\n        });\n        return\n      }\n      let res\n      let count = 0\n      if(this.toBindEventName !== \"batchBind\"){\n        res = await bindEvent({name:this.toBindEventName, userIDList: this.userIDList})\n        if(res.code === 200){\n          count += 1\n        }\n      }else{\n        for (const row of this.selectedRowKeys) {\n          res = await bindEvent({name:row.name, userIDList: this.userIDList})\n          if(res.code === 200){\n            count += 1\n          }\n        }\n      }\n      notification[\"success\"]({\n        message: '分配成功,' + count + '条' ,\n      });\n      this.closeModal()\n\n    },\n    updateEvent(record){\n      this.updateModalVisible = true\n      this.form = record\n    },\n    deleteEvent(id) {\n      const that = this\n      this.$confirm({\n        title: '确定要删除该事件吗?',\n        okText: '确定',\n        okType: 'danger',\n        cancelText: '取消',\n        async onOk() {\n            let res = await deleteEvent({ id: id })\n            if (res.code === 200) {\n              that.$notification.open({\n                message: '删除成功',\n                duration: 1,\n              });\n              this.getTableData()\n            }\n        },\n        onCancel() {\n          console.log('Cancel');\n        },\n      });\n    },\n    async getUserList(){\n      let res = await reqUserList({page_num:1, page_size:9999})\n      if(res.code === 200){\n        this.userList = res.result.users\n      }\n    }\n  },\n  created(){\n    this.getTableData()\n    this.getUserList()\n  }\n}\n",null]}